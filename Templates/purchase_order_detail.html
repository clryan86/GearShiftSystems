{% extends "base.html" %}
{% block content %}
<h2>PO #{{ po.id }} — {{ po.vendor.name if po.vendor else "Unassigned Vendor" }}</h2>
<p>
  Status: <strong>{{ po.status }}</strong><br>
  Created: {{ po.created_at.strftime("%Y-%m-%d %H:%M") if po.created_at else "" }}
  {% if po.approved_at %}<br>Approved: {{ po.approved_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
  {% if po.sent_at %}<br>Sent: {{ po.sent_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
  {% if po.received_at %}<br>Received: {{ po.received_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
</p>

<table class="table table-sm">
  <thead>
    <tr>
      <th>Part</th>
      <th>SKU</th>
      <th>Unit Cost</th>
      <th>Ordered</th>
      <th>Received</th>
      <th>Receive Now</th>
    </tr>
  </thead>
  <tbody>
    {% for it in po.items %}
      <tr>
        <td>{{ it.product.name }}</td>
        <td>{{ it.product.sku }}</td>
        <td>${{ "%.2f"|format(it.unit_cost or 0) }}</td>
        <td>{{ it.qty_ordered }}</td>
        <td>{{ it.qty_received or 0 }}</td>
        <td>
          <input form="receiveForm" class="form-control form-control-sm" type="number" min="0" name="receive_{{ it.id }}" placeholder="0">
        </td>
      </tr>
    {% endfor %}
    <tr>
      <td colspan="6" class="text-end"><strong>Total: ${{ "%.2f"|format(po.total) }}</strong></td>
    </tr>
  </tbody>
</table>

<div class="d-flex gap-2" style="display:flex; gap:8px; flex-wrap:wrap;">
  {% if po.status == "DRAFT" %}
    <form method="post" action="{{ url_for('po_approve', po_id=po.id) }}">
      <button class="btn btn-success">Approve</button>
    </form>
  {% endif %}

  {% if po.status in ["DRAFT", "APPROVED"] %}
    <form method="post" action="{{ url_for('po_send', po_id=po.id) }}">
      <button class="btn btn-primary">Send to Vendor</button>
    </form>
  {% endif %}

  {% if po.status in ["APPROVED", "SENT", "PARTIALLY_RECEIVED"] %}
    <form id="receiveForm" method="post" action="{{ url_for('po_receive', po_id=po.id) }}">
      <button class="btn btn-outline-primary">Receive Items</button>
    </form>
  {% endif %}

  {% if po.status not in ["RECEIVED"] %}
    <form method="post" action="{{ url_for('po_cancel', po_id=po.id) }}">
      <button class="btn btn-outline-danger">Cancel</button>
    </form>
  {% endif %}
</div>

<p class="mt-3"><a href="{{ url_for('po_list') }}">← Back to Purchase Orders</a></p>
{% endblock %}
