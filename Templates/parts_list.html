{% extends "base.html" %}
{% block content %}

<a class="btn mb-3" href="{{ url_for('index') }}"
   style="background:#1e293b; color:#38bdf8; border:1px solid #334155;">
  ‚öôÔ∏è GearShift Systems
</a>

<div class="card">
  <div class="title">Parts</div>

  <div class="toolbar" style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <a class="btn btn-primary" href="{{ url_for('add_part') }}">Add Part</a>
    <a class="btn btn-light" href="{{ url_for('export_parts') }}">Export CSV</a>

    <form method="get" action="{{ url_for('list_parts') }}" style="display:flex; gap:6px; align-items:center;">
      <input class="input" type="text" name="q" placeholder="Search name, SKU, vendor"
             value="{{ request.args.get('q','') }}" style="min-width:220px;">
      <label style="display:flex; gap:4px; align-items:center;">
        <input type="checkbox" name="low" value="1" {% if request.args.get('low') == '1' %}checked{% endif %}>
        Low Stock Only
      </label>
      <button class="btn btn-accent" type="submit">Filter</button>
      <a class="btn btn-light" href="{{ url_for('list_parts') }}">Clear</a>
    </form>

    <a class="btn btn-warn" href="{{ url_for('reorder_draft') }}">Draft Reorder</a>
    <!-- Cart shortcut -->
    <a class="btn btn-accent" href="{{ url_for('cart.view_cart') }}">üõí Cart ({{ cart_count or 0 }})</a>
  </div>

  {% if parts|length == 0 %}
    <p class="muted" style="margin-top:10px">No parts found.</p>
  {% else %}
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>SKU</th>
          <th class="right">Price</th>
          <th class="right">Stock</th>
          <th class="right">Threshold</th>
          <th>Shelf</th>
          <th>Vendor</th>
          <th class="right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for p in parts %}
        {% set stock_val  = (p.stock|default(0, true))|int %}
        {% set thresh_val = (p.reorder_threshold|default(0, true))|int %}
        {% set is_low     = stock_val <= thresh_val %}
        {% set price_val  = (p.price|default(0, true))|float %}
        {% set vendor_label =
             (p.vendor and (p.vendor.name or p.vendor.company_name)) or
             p.vendor_name or '‚Äî' %}
        <tr class="{{ 'row-low' if is_low }}">
          <td>
            {{ p.name }}
            {% if is_low %}<span class="badge-low">Low</span>{% endif %}
            <div class="muted small">SKU: {{ p.sku }}</div>
          </td>
          <td>{{ p.sku }}</td>
          <td class="right">${{ '%.2f'|format(price_val) }}</td>
          <td class="right">{{ stock_val }}</td>
          <td class="right">{{ thresh_val }}</td>
          <td>{{ p.shelf_location|default('‚Äî', true) }}</td>
          <td>{{ vendor_label }}</td>
          <td class="right" style="display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap;">
            <a class="btn btn-small" href="{{ url_for('edit_part', part_id=p.id) }}">Edit</a>

            <form action="{{ url_for('delete_part', part_id=p.id) }}"
                  method="post" style="display:inline"
                  onsubmit="return confirm('Delete this part?');">
              <button type="submit" class="btn btn-small btn-warn">Delete</button>
            </form>

            {% if stock_val > 0 %}
              <!-- Add to session cart -->
              <a class="btn btn-small btn-success"
                 href="{{ url_for('cart.add', part_id=p.id) }}">Add to Cart</a>
            {% else %}
              <button class="btn btn-small" disabled title="Out of stock">Add to Cart</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endblock %}
